<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Grow a Garden — Epic Edition</title>
<style>
  :root{--bg:#eaf6ea;--card:#fff;--muted:#657}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(#f0fff0,#e8f8ea);color:#0b3;margin:0;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0}
  .wrap{display:grid;grid-template-columns:320px 1fr 360px;gap:14px;margin-top:14px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
  #garden{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .plot{height:120px;border-radius:10px;background:linear-gradient(#fff,#f3fff3);display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #cfe;cursor:pointer}
  .plot.empty{background:linear-gradient(#fff,#fafafa);border:2px dashed #e3e}
  .controls button{margin:6px 4px;padding:8px;border-radius:8px;border:1px solid #cfc;background:#fff}
  .shop .item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #f0f0f0}
  .log{height:140px;overflow:auto;background:#fafafa;padding:8px;border-radius:6px;border:1px solid #eee;font-family:monospace;font-size:12px}
  .notice{font-size:.9rem;color:var(--muted)}
  .small{font-size:.85rem;color:#666}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:#666;font-size:.9rem}
  .badge{background:#def;border-radius:6px;padding:4px 8px;font-size:.8rem}
  footer{margin-top:10px;font-size:.85rem;color:#566}
</style>
</head><body>
<header>
  <h1>🌱 Grow a Garden — Epic</h1>
  <div class="row">
    <div class="badge">Gold: <span id="gold">0</span></div>
    <div class="badge">Day: <span id="day">1</span></div>
  </div>
</header>

<div class="wrap">
  <aside class="card">
    <h3>Seeds & Shop</h3>
    <div id="shop" class="shop"></div>
    <hr/>
    <h4>Research</h4>
    <div id="research"></div>
    <hr/>
    <div class="row">
      <button id="saveBtn">Save</button>
      <button id="exportBtn">Export</button>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
      <button id="importBtn">Import</button>
    </div>
    <hr/>
    <div>
      <button id="toggleDebug">Toggle Debug</button>
      <div id="debugPanel" style="display:none;margin-top:8px">
        <button id="cheatGold">+1000 Gold</button>
        <button id="massGrow">Grow +10 days</button>
        <button id="unlockAll">Unlock all seeds</button>
      </div>
    </div>
  </aside>

  <main class="card">
    <h3>Your Garden — <span id="biomeName">Meadow</span></h3>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
      <select id="biomeSelect">
        <option value="meadow">Meadow</option>
        <option value="greenhouse">Greenhouse</option>
        <option value="desert">Desert</option>
      </select>
      <button id="travelBiome">Travel</button>
      <div class="muted">Workers: <span id="workers">0</span> • Plots: <span id="plotCount">12</span></div>
    </div>

    <div id="garden"></div>

    <div style="margin-top:12px" class="controls">
      <button id="plantBtn">Plant Selected Seed</button>
      <button id="waterBtn">Water</button>
      <button id="harvestBtn">Harvest</button>
      <button id="clearBtn">Clear Plot</button>
      <select id="plotSelect"></select>
    </div>

    <footer>
      Tip: breeding two mature plants in two adjacent plots gives a chance for hybrids. Watering and weather change growth speed.
    </footer>
  </main>

  <aside class="card">
    <h3>Info & Achievements</h3>
    <p><strong>Selected:</strong> <span id="selectedSeed">None</span></p>
    <p class="small">Weather: <span id="weather">Clear</span></p>
    <div style="margin-top:8px">
      <h4>Achievements</h4>
      <div id="achievements"></div>
    </div>
    <hr/>
    <h4>Activity Log</h4>
    <div id="log" class="log"></div>

    <hr/>
    <div>
      <h4>Quick Actions</h4>
      <button id="hireWorker">Hire Worker (200g)</button>
    </div>
  </aside>
</div>

<script>
/* ====== Include GameAPI from templates (inline) ====== */
const GameAPI = {
  init(opts){
    this.id = opts.id || 'game';
    this.saveKey = `save_${this.id}`;
    this.version = opts.version || '1';
    this.state = opts.initialState || {};
    this.achievements = {};
    this.notificationsEl = null;
    window.addEventListener('beforeunload', ()=> this.save());
  },
  bindUI(el){ this.notificationsEl = el; },
  save(){ localStorage.setItem(this.saveKey, JSON.stringify({v:this.version, state:this.state, ach:this.achievements})); this.notify('Saved'); },
  load(){ const raw = localStorage.getItem(this.saveKey); if(!raw) return false; try{ const obj=JSON.parse(raw); this.state = obj.state||this.state; this.achievements = obj.ach||this.achievements; this.notify('Loaded'); return true;}catch(e){console.warn(e); return false;} },
  export(){ const raw = localStorage.getItem(this.saveKey); if(!raw) return alert('No save'); const blob = new Blob([raw],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${this.id}_save.json`; a.click(); URL.revokeObjectURL(url); },
  import(file, cb){ const r = new FileReader(); r.onload = e=>{ try{ const obj = JSON.parse(e.target.result); localStorage.setItem(this.saveKey, e.target.result); this.load(); if(cb) cb(true); }catch(e){ if(cb) cb(false); } }; r.readAsText(file); },
  earnAchievement(key,desc){ if(this.achievements[key]) return; this.achievements[key]=true; this.notify(`Achievement: ${desc}`); console.log('ACH',key); },
  notify(msg,ttl=2500){ if(this.notificationsEl){ const el = document.createElement('div'); el.textContent = msg; el.style.padding='8px'; el.style.background='rgba(0,0,0,0.7)'; el.style.color='#fff'; el.style.marginTop='6px'; el.style.borderRadius='6px'; this.notificationsEl.prepend(el); setTimeout(()=>el.remove(), ttl);} else console.log('NOTIFY',msg); },
  cheat(name,fn){ if(!this._cheats) this._cheats={}; this._cheats[name]=fn; },
  runCheat(name){ if(this._cheats && this._cheats[name]) this._cheats[name](); }
};

/* ====== Game data & state ====== */
const BIOMES = {
  meadow: {name:'Meadow', growthMod:1.0},
  greenhouse: {name:'Greenhouse', growthMod:1.6},
  desert: {name:'Desert', growthMod:0.8}
};

const BASE_SEEDS = [
  {id:'flower', name:'Flower', cost:5, grow:2, sell:8, emoji:'🌸', rarity:1},
  {id:'tomato', name:'Tomato', cost:12, grow:4, sell:25, emoji:'🍅', rarity:2},
  {id:'tree', name:'Apple Tree', cost:50, grow:10, sell:220, emoji:'🌳', rarity:3},
  {id:'cactus', name:'Cactus', cost:20, grow:6, sell:60, emoji:'🌵', rarity:2}
];

const initialState = {
  gold: 100,
  day: 1,
  biome: 'meadow',
  weather: 'Clear',
  plots: Array.from({length:12},()=>({seed:null, age:0, watered:false})),
  selectedSeed: null,
  selectedPlot: 0,
  workers: 0,
  upgrades: {speed:0,yield:0},
  unlockedSeeds: {'flower':true},
  auto: false
};

GameAPI.init({id:'grow_epic',version:'1.0', initialState});
GameAPI.bindUI(document.getElementById('log'));
GameAPI.state = Object.assign({}, initialState, GameAPI.state);

/* ====== Dynamic seeds (allow unlocks and hybrids) ====== */
let seeds = BASE_SEEDS.map(s=>Object.assign({},s));
function getSeedById(id){ return seeds.find(x=>x.id===id); }
function unlockSeed(id){ GameAPI.state.unlockedSeeds[id]=true; GameAPI.notify('Unlocked seed: '+id); }

/* ====== UI helpers ====== */
const $ = id => document.getElementById(id);
function log(msg){ const l = $('log'); l.innerHTML = new Date().toLocaleTimeString() + ' — ' + msg + '\n' + l.innerHTML; }
function saveAndRender(){ GameAPI.save(); renderAll(); }

/* ====== Rendering ====== */
function renderAll(){
  $('gold').textContent = GameAPI.state.gold;
  $('day').textContent = GameAPI.state.day;
  $('biomeName').textContent = BIOMES[GameAPI.state.biome].name;
  $('workers').textContent = GameAPI.state.workers;
  $('plotCount').textContent = GameAPI.state.plots.length;
  $('selectedSeed').textContent = GameAPI.state.selectedSeed ? GameAPI.state.selectedSeed.name : 'None';
  $('weather').textContent = GameAPI.state.weather;
  renderGarden();
  renderShop();
  renderResearch();
  renderAchievements();
}
function renderGarden(){
  const g = $('garden'); g.innerHTML='';
  GameAPI.state.plots.forEach((p,i)=>{
    const div = document.createElement('div'); div.className = 'plot' + (p.seed? '' : ' empty');
    div.dataset.idx = i;
    if(p.seed){
      const s = p.seed;
      const stage = Math.min(Math.ceil((p.age+1)/Math.max(1,Math.floor(s.grow/3))), s.grow);
      div.innerHTML = `<div style="font-size:34px">${s.emoji}</div><div style="font-size:12px">${s.name} • age ${p.age}/${s.grow} • stage ${stage}</div><div style="font-size:11px;color:${p.watered?'blue':'#999'}">${p.watered?'Watered':'Dry'}</div>`;
    } else {
      div.innerHTML = '<div style="color:#aaa">Empty</div>';
    }
    div.onclick = ()=>{ GameAPI.state.selectedPlot = i; $('plotSelect').value = i; renderAll(); };
    if(GameAPI.state.selectedPlot==i) div.style.boxShadow = '0 0 0 4px rgba(0,128,0,0.06)';
    g.appendChild(div);
  });
  const sel = $('plotSelect'); sel.innerHTML = '';
  GameAPI.state.plots.forEach((p,i)=>{ const o=document.createElement('option'); o.value=i; o.text = `Plot ${i+1} — ${p.seed? p.seed.name + ' (age '+p.age+')' : 'empty'}`; sel.add(o);});
}

/* ====== Shop & Research ====== */
function renderShop(){
  const s = $('shop'); s.innerHTML='';
  seeds.forEach(seed=>{
    if(!GameAPI.state.unlockedSeeds[seed.id]) return;
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div><strong>${seed.emoji} ${seed.name}</strong><div class="small">Grow ${seed.grow} days • Sell ${seed.sell}g</div></div>
      <div><div style="text-align:right">${seed.cost}g</div><div style="margin-top:6px"><button data-id="${seed.id}">Buy</button></div></div>`;
    row.querySelector('button').onclick = ()=>buySeed(seed.id);
    s.appendChild(row);
  });
}
function renderResearch(){
  const r = $('research'); r.innerHTML='';
  const items = [
    {id:'hydro',name:'Hydroponics (unlock greenhouse)',cost:300,unlocked:GameAPI.state.upgrades.hydro},
    {id:'genetics',name:'Genetics Lab (breeding bonus)',cost:200,unlocked:GameAPI.state.upgrades.genetics}
  ];
  items.forEach(it=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div>${it.name} ${it.unlocked? '✅':'(cost '+it.cost+'g)'}</div><div><button data-res="${it.id}">${it.unlocked? 'Owned' : 'Research'}</button></div>`;
    el.querySelector('button').onclick = ()=>{ if(it.unlocked) return; if(GameAPI.state.gold < it.cost) return alert('Not enough'); GameAPI.state.gold -= it.cost; GameAPI.state.upgrades[it.id]=true; GameAPI.notify('Researched '+it.name); saveAndRender(); };
    r.appendChild(el);
  });
}

/* ====== Planting / watering / harvesting ====== */
function buySeed(id){
  const seed = getSeedById(id);
  if(!seed) return;
  if(GameAPI.state.gold < seed.cost) { alert('Not enough gold'); return; }
  GameAPI.state.gold -= seed.cost;
  GameAPI.state.selectedSeed = seed;
  log(`Bought ${seed.name} for ${seed.cost}g`);
  saveAndRender();
}
function plantSelected(){
  if(!GameAPI.state.selectedSeed) { alert('Select a seed first'); return; }
  const plot = GameAPI.state.plots[GameAPI.state.selectedPlot];
  if(plot.seed) { alert('Plot occupied'); return; }
  // clone seed object and add genetics
  const s = Object.assign({}, GameAPI.state.selectedSeed);
  s.genetics = {speed:1 + Math.random()*0.4, yield:1 + Math.random()*0.3};
  plot.seed = s; plot.age=0; plot.watered=false;
  GameAPI.state.selectedSeed = null;
  log(`Planted ${plot.seed.name} in plot ${GameAPI.state.selectedPlot+1}`);
  saveAndRender();
}
function waterSelected(){
  const p = GameAPI.state.plots[GameAPI.state.selectedPlot];
  if(!p.seed) return alert('Nothing planted');
  p.watered = true; log('Watered plot '+(GameAPI.state.selectedPlot+1)); saveAndRender();
}
function harvestSelected(){
  const p = GameAPI.state.plots[GameAPI.state.selectedPlot];
  if(!p.seed) return alert('Nothing to harvest');
  if(p.age < p.seed.grow) return alert('Not ready yet');
  const base = p.seed.sell;
  const bonus = (GameAPI.state.upgrades.yield||0) * 0.15;
  const geneticsBonus = p.seed.genetics? p.seed.genetics.yield : 1;
  const earned = Math.round(base * (1 + bonus) * geneticsBonus);
  GameAPI.state.gold += earned;
  log(`Harvested ${p.seed.name} for ${earned}g`);
  // breeding chance if adjacent plot has a mature plant
  const adj = findAdjacentPlot(GameAPI.state.selectedPlot);
  if(adj !== null){
    const other = GameAPI.state.plots[adj];
    if(other.seed && other.age >= other.seed.grow){
      // create possible hybrid
      if(Math.random() < 0.25 + (GameAPI.state.upgrades.genetics? 0.15:0)){
        const hybrid = makeHybrid(p.seed, other.seed);
        seeds.push(hybrid);
        unlockSeed(hybrid.id);
        log('A hybrid appeared: '+hybrid.name);
        GameAPI.notify('New hybrid unlocked: '+hybrid.name);
      }
    }
  }
  p.seed = null; p.age = 0; p.watered = false;
  if(GameAPI.state.gold >= 500 && !GameAPI.achievements['wealthy']) GameAPI.earnAchievement('wealthy','Wealthy Gardener');
  saveAndRender();
}
function clearPlot(){ const p = GameAPI.state.plots[GameAPI.state.selectedPlot]; p.seed=null;p.age=0;p.watered=false; log('Cleared plot'); saveAndRender(); }

/* ====== Hybrid mechanics ====== */
function makeHybrid(a,b){
  const id = `${a.id}_${b.id}_hyb_${Math.floor(Math.random()*10000)}`;
  const name = `${a.name}-${b.name} Hybrid`;
  const emoji = a.emoji || '🌱';
  const grow = Math.max(1, Math.round((a.grow + b.grow)/2 + (Math.random()*2 -1)));
  const cost = Math.round((a.cost + b.cost)/2 + 5);
  const sell = Math.round((a.sell+b.sell)/2 * (1 + Math.random()*0.3));
  const gen = {speed:(a.genetics.speed + b.genetics.speed)/2 * (1 + (Math.random()*0.2-0.1)), yield:(a.genetics.yield + b.genetics.yield)/2*(1+(Math.random()*0.2-0.1))};
  return {id,name,cost,grow,sell,emoji,rarity:Math.max(a.rarity,b.rarity),genetics:gen};
}

/* ====== Adjacent helper ====== */
function findAdjacentPlot(idx){
  // garden grid 4 columns, N rows
  const cols = 4;
  const left = idx % cols !== 0 ? idx - 1 : null;
  const right = (idx % cols) !== cols - 1 ? idx + 1 : null;
  if(left !== null) return left;
  if(right !== null) return right;
  return null;
}

/* ====== Day tick & weather & workers ====== */
function tickDay(){
  GameAPI.state.day++;
  // weather toggles
  const roll = Math.random();
  if(roll < 0.12) GameAPI.state.weather = 'Rain';
  else if(roll < 0.18) GameAPI.state.weather = 'Frost';
  else GameAPI.state.weather = 'Clear';
  const biomeMod = BIOMES[GameAPI.state.biome].growthMod;
  GameAPI.state.plots.forEach(p=>{
    if(p.seed){
      let speedBonus = 1 + (GameAPI.state.upgrades.speed||0)*0.2;
      if(p.watered) speedBonus += 0.8;
      if(GameAPI.state.weather === 'Rain') speedBonus += 0.5;
      if(GameAPI.state.weather === 'Frost') speedBonus -= 0.6;
      speedBonus *= biomeMod;
      // genetics multiplier
      const genSpeed = p.seed.genetics? p.seed.genetics.speed : 1;
      const inc = Math.max(1, Math.floor(speedBonus * genSpeed));
      p.age += inc;
      p.watered = false;
      if(p.age >= p.seed.grow) log(`${p.seed.name} matured in a plot`);
    }
  });
  // workers auto actions
  for(let i=0;i<GameAPI.state.workers;i++){
    // find a needy plot and water/harvest
    const needWater = GameAPI.state.plots.findIndex(p=>p.seed && !p.watered && p.age < p.seed.grow);
    if(needWater !== -1) GameAPI.state.plots[needWater].watered = true;
    const ready = GameAPI.state.plots.findIndex(p=>p.seed && p.age >= p.seed.grow);
    if(ready !== -1){
      // harvest automatically and sell
      const p = GameAPI.state.plots[ready];
      const earned = Math.round(p.seed.sell * 0.8);
      GameAPI.state.gold += earned;
      log(`Worker harvested ${p.seed.name} for ${earned}g`);
      p.seed = null; p.age = 0;
    }
  }
  // mature tree income example
  const trees = GameAPI.state.plots.filter(p=>p.seed && p.seed.id==='tree' && p.age >= p.seed.grow).length;
  if(trees) { const inc = trees * 4; GameAPI.state.gold += inc; log(`Collected ${inc}g from mature trees`); }
  if(GameAPI.state.day >= 30 && !GameAPI.achievements['month']) GameAPI.earnAchievement('month','Month of Gardening');
  saveAndRender();
}

/* ====== Travel between biomes (unlocks greenhouse) ====== */
function travelTo(b){
  if(b === GameAPI.state.biome) return;
  // require research for greenhouse
  if(b === 'greenhouse' && !GameAPI.state.upgrades.hydro) return alert('Research Hydroponics first (300g)');
  GameAPI.state.biome = b; GameAPI.notify('Traveled to '+BIOMES[b].name); saveAndRender();
}

/* ====== Workers & Upgrades ====== */
function hireWorker(){
  if(GameAPI.state.gold < 200) return alert('Not enough gold');
  GameAPI.state.gold -= 200; GameAPI.state.workers++; log('Hired a worker'); saveAndRender();
}

/* ====== Achievements rendering ====== */
function renderAchievements(){
  const el = $('achievements'); el.innerHTML='';
  const keys = Object.keys(GameAPI.achievements);
  if(keys.length === 0) { el.innerHTML = '<div class="small">No achievements yet</div>'; return; }
  keys.forEach(k=>{ const d = document.createElement('div'); d.textContent = k; el.appendChild(d); });
}

/* ====== Cheats & debug ====== */
$('toggleDebug').onclick = ()=>{ const p = $('debugPanel'); p.style.display = p.style.display === 'none' ? 'block' : 'none'; };
$('cheatGold').onclick = ()=>{ GameAPI.state.gold += 1000; log('Cheat: gave 1000 gold'); saveAndRender(); };
$('massGrow').onclick = ()=>{ GameAPI.state.plots.forEach(p=>{ if(p.seed) p.age += 10; }); saveAndRender(); };
$('unlockAll').onclick = ()=>{ seeds.forEach(s=>unlockSeed(s.id)); saveAndRender(); };

/* ====== Buttons wiring ====== */
$('plantBtn').onclick = plantSelected;
$('waterBtn').onclick = waterSelected;
$('harvestBtn').onclick = harvestSelected;
$('clearBtn').onclick = clearPlot;
$('plotSelect').onchange = (e)=>{ GameAPI.state.selectedPlot = Number(e.target.value); renderAll(); };
$('saveBtn').onclick = ()=>GameAPI.save();
$('exportBtn').onclick = ()=>GameAPI.export();
$('importBtn').onclick = ()=>$('importFile').click();
$('importFile').onchange = (e)=>{ const f = e.target.files[0]; if(!f) return; GameAPI.import(f, ok=>{ if(ok) renderAll(); else alert('Import failed'); }); };
$('hireWorker').onclick = hireWorker;
$('travelBiome').onclick = ()=>travelTo($('biomeSelect').value);

/* ====== Game loop & autosave ====== */
let autoInterval = setInterval(()=>{ tickDay(); }, 6000); // every 6s = 1 day
setInterval(()=>GameAPI.save(), 10000);

/* ====== init ====== */
GameAPI.cheat('rich', ()=>{ GameAPI.state.gold += 9999; saveAndRender(); });
GameAPI.load();
renderAll();
log('Welcome to Grow a Garden — Epic edition! Tip: use debug to unlock seeds and test hybrid mechanics.');
</script>
</body></html>
